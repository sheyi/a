"use strict";var tooltipList,emulator;function tools_enableAllBtn(){document.querySelectorAll(".tool_btn-svg").forEach((t=>{t.classList.remove("tool_disabled"),t.disabled=!1}))}async function playGame(t){showFirstGameLoading(),await initIndexedDB(win_db.database,[win_db.t_disk,win_db.t_snapshot,win_db.t_bios]);let e=await loadIndexedDB(win_db.database,win_db.t_disk,t.id);if(null!=e){let o=t.hda;delete o.url,o.buffer=e,o.size=o.buffer.byteLength,o.async=!1}Log.log(JSON.stringify(t,null,2)),createEmulator(t)}function createEmulator(t){t.wasm_path:"/win/v86.wasm",t.screen_container=document.getElementById("screen_container"),t.bios={url:"/win/seabios.bin"},t.vga_bios={url:"/win/vgabios.bin"},t.fastboot=!0,t.autostart=!1,(emulator=new V86(t)).context=t,addEmulatorListener(),addOperationListener()}function addEmulatorListener(){emulator.add_listener("download-progress",(function(e){!function(e){let o=document.getElementById("game-loading");o.style.display="block";const n=e.file_name.split("/");let a=n[n.length-1];a.includes("wasm")?a="game.wasm":a.includes("bios")||(a="游戏中 ");if("游戏中"==a&&e.loaded>=e.total-2048)return;let l="加载"+a+" ";if(e.total&&"number"==typeof e.loaded){let t=Math.floor(e.loaded/e.total*100);t=Math.min(100,Math.max(0,t)),l+=t+"% "}else l+=".".repeat(t++%50);o.innerText=l}(e)})),emulator.add_listener("download-error",(function(t){var e=document.getElementById("game-loading");e.style.display="block",e.textContent="加载游戏 "+t.file_name+" 出错"}));var t=0;emulator.add_listener("emulator-ready",(function(){Log.log("emulator-ready"),null!=this.context.hda.url&&0==this.context.hda.async&&saveIndexedDB(win_db.database,win_db.t_disk,this.context.id,this.disk_images.hda.buffer),this.run(),tools_enableAllBtn()})),emulator.add_listener("emulator-started",(function(){Log.log("emulator-started")})),emulator.add_listener("emulator-loaded",(function(){document.getElementById("game-loading").style.display="none",Log.log("emulator-loaded")})),emulator.add_listener("emulator-stop",(function(){}))}function showFirstGameLoading(){let t=document.getElementById("game-loading");t.style.display="block",t.innerText="加载游戏中"}function addOperationListener(){let t=document.getElementById("restart");t&&t.addEventListener("click",(async function(){await blueRestart()}));let e=document.getElementById("lock_mouse");e&&e.addEventListener("click",(function(t){emulator.lock_mouse(),this.blur()}));let o=document.getElementById("tool_fullscreen");o&&o.addEventListener("click",(function(t){emulator.lock_mouse(),emulator.screen_go_fullscreen();try{navigator.keyboard.lock()}catch(t){}this.blur()}));let n=document.getElementById("screen_container");n&&n.addEventListener("click",(function(t){emulator.lock_mouse&&(emulator.lock_mouse(),this.blur())}));let a=document.getElementById("game_container");a&&a.addEventListener("contextmenu",(function(t){t.preventDefault(),t.stopPropagation()}));const l=document.getElementById("vga");if(l){new ResizeObserver(((t,e)=>{t.forEach((t=>{const{contentRect:e,target:o}=t;0!=e.width&&0!=e.height&&(e.width<640||e.height<480)&&(o.style.width="100%",o.style.height="100%")}))})).observe(l)}window.addEventListener("beforeunload",(function(t){emulator.disk_images.hda.buffer=null,emulator.destroy();let e="确定要离开此页面吗？";return t.returnValue=e,e}));let i=document.getElementById("tool_save");i&&(i.addEventListener("click",(async function(t){this.setAttribute("data-bs-original-title","保存中"),d("tool_save").show(),this.classList.add("tool_disabled"),this.disabled=!0;let e=await emulator.save_state();await saveIndexedDB(win_db.database,win_db.t_snapshot,emulator.context.id,e),e=null,this.classList.remove("tool_disabled"),this.disabled=!1,this.setAttribute("data-bs-original-title","保存成功"),d("tool_save").hide(),d("tool_save").toggle(),setTimeout((function(){d("tool_save").hide()}),2e3)})),i.addEventListener("mouseover",(function(){"保存"!=this.getAttribute("data-bs-original-title")&&(this.setAttribute("data-bs-original-title","保存"),d("tool_save").show())})));let s=document.getElementById("tool_load");function d(t){for(let e=0;e<tooltipList.length;e++)if(tooltipList[e]._element.id==t)return tooltipList[e]}s&&(s.addEventListener("click",(async function(t){this.setAttribute("data-bs-original-title","读取中"),d("tool_load").show(),this.classList.add("tool_disabled"),this.disabled=!0;let e="没有存档",o=await loadIndexedDB(win_db.database,win_db.t_snapshot,emulator.context.id);null!=o&&(await emulator.restore_state(o),e="读取成功"),o=null,this.classList.remove("tool_disabled"),this.disabled=!1,this.setAttribute("data-bs-original-title",e),d("tool_load").hide(),d("tool_load").toggle(),setTimeout((function(){d("tool_load").hide()}),2e3)})),s.addEventListener("mouseover",(function(){"读取"!=this.getAttribute("data-bs-original-title")&&(this.setAttribute("data-bs-original-title","读取"),d("tool_load").show())})))}window.addEventListener("load",(function(){document.getElementById("game-start").style.display="block",document.getElementById("game-start-loading").style.display="none",document.getElementById("game-start").addEventListener("click",(function(t){document.getElementById("game-start").style.display="none",playGame(context)}));let t=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));tooltipList=t.map((function(t){return new bootstrap.Tooltip(t)}))}));var win_db={database:"windows_game",t_snapshot:"snapshot",t_disk:"disk",t_bios:"bios"};async function blueRestart(){emulator.disk_images.hda.buffer=null;let t=await loadIndexedDB(win_db.database,win_db.t_disk,emulator.context.id);null!=t&&(emulator.disk_images.hda.buffer=t,emulator.restart())}window.addEventListener("load",(function(){const t=async(t,o)=>{480==document.getElementById("screen").childNodes.length&&(o.disconnect(),await blueRestart(),setTimeout((function(){e()}),1e3));let n=document.querySelectorAll("#screen > div > span");for(let t=0;t<n.length;t++)if("windows"==n[t].innerText.trim().toLowerCase()){o.disconnect(),await blueRestart(),setTimeout((function(){e()}),1e3);break}};function e(){new MutationObserver(t).observe(document.getElementById("screen"),{childList:!0})}e()}));